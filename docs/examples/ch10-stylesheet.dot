// ch10-stylesheet.dot
// Demonstrates model_stylesheet with CSS-like selectors.
// The stylesheet assigns models by tier: a fast default,
// a stronger model for critical nodes, and a specific
// override for the Evaluate node.

digraph task_manager {
    goal = "Build a task management API"

    model_stylesheet = "
        * {
            llm_model: claude-haiku-3-5;
            reasoning_effort: low;
        }
        .critical {
            llm_model: claude-sonnet-4-20250514;
            reasoning_effort: high;
        }
        #Evaluate {
            llm_model: claude-opus-4-20250514;
        }
    "

    Start [shape=Mdiamond label="Start"]

    Plan [
        shape=box
        label="Plan"
        prompt="Create a detailed project plan for: $goal. List the endpoints, data models, and implementation steps."
        max_retries=3
    ]

    Implement [
        shape=box
        label="Implement"
        prompt="Implement the plan from the previous step for: $goal. Write the Python code with FastAPI endpoints and Pydantic models."
        goal_gate=true
        retry_target="Plan"
    ]

    Evaluate [
        shape=box
        label="Evaluate"
        prompt="Review the implementation for correctness, completeness, and code quality. Return success if the code meets the plan requirements, or fail with specific feedback."
        goal_gate=true
        retry_target="Plan"
    ]

    RunTests [
        shape=parallelogram
        label="Run Tests"
        tool_command="cd workspace && uv run pytest tests/ -v --tb=short"
        timeout="60s"
    ]

    Review [shape=hexagon label="Review"]

    FinalReview [
        shape=box
        label="Final Review"
        prompt="Perform a final quality check on the complete implementation. Verify all endpoints work, models are correct, and tests pass."
        goal_gate=true
        retry_target="Implement"
    ]

    Exit [shape=Msquare label="Exit"]

    // Subgraph creates the "critical" class.
    // Nodes listed here match the .critical selector.
    subgraph critical {
        Evaluate
        FinalReview
    }

    Start -> Plan
    Plan -> Implement
    Implement -> Evaluate
    Evaluate -> RunTests
    RunTests -> FinalReview
    FinalReview -> Review

    Review -> Exit [label="[A] Approve"]
    Review -> Plan [label="R) Revise"]
}
