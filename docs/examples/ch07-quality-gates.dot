// ch07-quality-gates.dot
// Adds goal gates and an LLM-as-judge evaluation node.
// The engine checks goal gates at the exit node. If Implement
// failed, execution jumps back to Plan automatically.

digraph task_manager {
    goal = "Build a task management API"

    Start [shape=Mdiamond label="Start"]

    Plan [
        shape=box
        label="Plan"
        prompt="Create a detailed project plan for: $goal. List the endpoints, data models, and implementation steps."
        max_retries=3
    ]

    Implement [
        shape=box
        label="Implement"
        prompt="Implement the plan from the previous step for: $goal. Write the Python code with FastAPI endpoints and Pydantic models."
        goal_gate=true
        retry_target="Plan"
    ]

    Evaluate [
        shape=box
        label="Evaluate"
        prompt="Review the implementation for correctness, completeness, and code quality. Return success if the code meets the plan requirements, or fail with specific feedback."
        llm_model="claude-sonnet-4-20250514"
        goal_gate=true
        retry_target="Plan"
    ]

    Review [shape=hexagon label="Review"]

    Exit [shape=Msquare label="Exit"]

    Start -> Plan
    Plan -> Implement
    Implement -> Evaluate
    Evaluate -> Review

    Review -> Exit [label="[A] Approve"]
    Review -> Plan [label="R) Revise"]
}
