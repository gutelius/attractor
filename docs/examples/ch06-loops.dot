// ch06-loops.dot
// Adds a review-revise loop: if the reviewer rejects, the pipeline
// loops back to Plan and tries again. max_retries prevents infinite loops.

digraph task_manager {
    goal = "Build a task management API"

    Start [shape=Mdiamond label="Start"]

    Plan [
        shape=box
        label="Plan"
        prompt="Create a detailed project plan for: $goal. List the endpoints, data models, and implementation steps."
        max_retries=3
    ]

    Implement [
        shape=box
        label="Implement"
        prompt="Implement the plan from the previous step for: $goal. Write the Python code with FastAPI endpoints and Pydantic models."
        retry_target="Plan"
    ]

    // Human review gate with a loop-back edge.
    Review [shape=hexagon label="Review"]

    Exit [shape=Msquare label="Exit"]

    Start -> Plan
    Plan -> Implement
    Implement -> Review

    Review -> Exit [label="[A] Approve"]
    // This edge creates a loop: rejection sends the pipeline back to Plan.
    Review -> Plan [label="R) Revise"]
}
